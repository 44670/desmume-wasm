<!doctype html>
<html>

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="dark.css" rel="stylesheet">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
</head>

<body>
    <style>
        body {
            background-color: black;
        }
        canvas {
            image-rendering: pixelated;
        }
    </style>
    <input id="rom" type="file"><br>
    <div id="fps"></div><br>
    <canvas id="top" width="256" height="192"></canvas><br>
    <canvas id="bottom" width="256" height="192"></canvas><br>
    <script src="localforage.js"></script>
    <script src="build/nds.js"></script>
    <script>

        window.onerror = function (msg, url, line, col, error) {
            var extra = !col ? '' : '\ncolumn: ' + col;
            extra += !error ? '' : '\nerror: ' + error;
            alert("Error: " + msg + "\nurl: " + url + "\nline: " + line + extra);
            window.onerror = console.log
            debugger
            return true;
        };
        function $id(id) {
            return document.getElementById(id);
        }
        var emuIsRunning = false
        var fps = 0
        var divFPS = $id('fps')
        var fileInput = $id('rom')
        async function save(name) { var buf = await fileInput.files[0].arrayBuffer(); await localforage.setItem(name, new Uint8Array(buf)) }
        var MemU8 = new Uint8Array()

        var FB = [0,0]
        var screenCanvas = [document.getElementById('top'), document.getElementById('bottom')]
        var ctx2d = screenCanvas.map((v) => { return v.getContext('2d', { alpha: false }) })

        var audioContext
        var scriptProcessor
        var AUDIO_BLOCK_SIZE = 1024
        var AUDIO_ORIG_SAMPLES_DESIRED = (AUDIO_BLOCK_SIZE / 48000) * 32823.6328125
        var audioBuffer

        var frameCount = 0
        var prevCalcFPSTime = 0
        var shouldDraw = 0
        var keyMask = 0
        var touched = 0
        var touchX = 0
        var touchY = 0

        function emuRunFrame() {
            shouldDraw = !shouldDraw;
            Module._runFrame(shouldDraw, keyMask, touched, touchX, touchY)

            //console.log(frontBuffer)
            if (shouldDraw) {
                ctx2d[0].putImageData(FB[0], 0, 0)
                ctx2d[1].putImageData(FB[1], 0, 0)
            }

            frameCount++
            if (frameCount % 8 == 0) {
                var time = performance.now()
                fps = 8 / ((time - prevCalcFPSTime) / 1000)
                prevCalcFPSTime = time
                divFPS.innerText = 'fps:' + fps
            }
        }

        async function wasmReady() {
            MemU8 = Module.HEAPU8
            ptrFrontBuffer = Module._getSymbol(5)
            var fb = Module._getSymbol(4)
            for (var i = 0; i < 2; i++) {
                FB[i] = new ImageData(new Uint8ClampedArray(MemU8.buffer).subarray(fb + 256 * 192 * 4 * i, fb + 256 * 192 * 4 * (i + 1)), 256, 192)
            }
            var ptrAudio = Module._getSymbol(6)
            audioBuffer = new Int16Array(MemU8.buffer).subarray(ptrAudio / 2, ptrAudio / 2 + 2048)

            var ROM = await localforage.getItem('rom')

            if (!(ROM)) {
                alert('please select file')
                return
            }
            
            MemU8.set(ROM, Module._prepareRomBuffer(ROM.length));
            var ret = Module._loadROM(ROM.length);
            console.log('loadrom result', ret)
            emuIsRunning = true
            //emuLoop()
            setInterval(emuRunFrame, 1000/120)
        }

        fileInput.onchange = async () => {
            alert('change')
            var file = fileInput.files[0]
            if (!file) {
                return
            }
            var buf = new Uint8Array(await file.arrayBuffer())
            var fileType = 'rom'
            if (buf.length == 4096) {
                fileType = 'bios9'
            }
            if (buf.length == 16384) {
                fileType = 'bios7'
            }
            if (buf.length == 256 * 1024) {
                fileType = 'firmware'
            }

            await localforage.setItem(fileType, buf)
            alert(fileType + ' loaded!')

        }

        function processAudio(event) {
            var samplesDesired = AUDIO_ORIG_SAMPLES_DESIRED
            if (fps > 0.1) {
                samplesDesired = AUDIO_ORIG_SAMPLES_DESIRED * (fps / 59.8261)
            }
            var outputBuffer = event.outputBuffer
            var audioData0 = outputBuffer.getChannelData(0)
            var audioData1 = outputBuffer.getChannelData(1)


            Module._fillAudioBuffer(AUDIO_BLOCK_SIZE, samplesDesired)
            for (var i = 0; i < AUDIO_BLOCK_SIZE; i++) {
                audioData0[i] = audioBuffer[i * 2] / 32768.0
                audioData1[i] = audioBuffer[i * 2 + 1] / 32768.0
            }

        }

        // must be called in user gesture
        function tryInitSound() {
            return;
            if (audioContext) {
                if (audioContext.state != 'running') {
                    audioContext.resume()
                }
                return;
            }
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)({ latencyHint: 0.0001, sampleRate: 48000 });
                scriptProcessor = audioContext.createScriptProcessor(AUDIO_BLOCK_SIZE, 0, 2)
                scriptProcessor.onaudioprocess = processAudio
                scriptProcessor.connect(audioContext.destination)

                audioContext.resume()
            } catch (e) {
                console.log(e)
                //alert('Cannnot init sound ')
            }
        }
/*
        function emuLoop() {
            window.requestAnimationFrame(emuLoop)
            emuRunFrame()
        }*/

        function handleTouch(event) {
            tryInitSound()
            if (!emuIsRunning) {
                return
            }
            event.preventDefault();
            event.stopPropagation();
            for (var i = 0; i < event.touches.length; i++) {
                var t = event.touches[i];
                var dom = document.elementFromPoint(t.clientX, t.clientY)
                if (dom == screenCanvas[1]) {
                }
            }
        }
        ['touchstart', 'touchmove', 'touchend', 'touchcancel', 'touchenter', 'touchleave'].forEach((val) => {
            window.addEventListener(val, handleTouch)
        })




        window.onmousedown = window.onmouseup = window.onmousemove = (e) => {
            if (!emuIsRunning) {
                return
            }
            if (e.type == 'mousedown') {
                tryInitSound()
            }
            var target = document.elementFromPoint(e.clientX, e.clientY)
            if (target != screenCanvas[1]) {
                if (!touched) {
                    return
                }
            }
            e.preventDefault()
            e.stopPropagation()
            var r = screenCanvas[1].getBoundingClientRect()
            var isDown = (e.buttons != 0) && (target == screenCanvas[1])
            var x = (e.clientX - r.x) / r.width * 256
            var y = (e.clientY - r.y) / r.height * 192

            touched = isDown ? 1 : 0;
            touchX = x
            touchY = y
        }

    </script>
</body>

</html>